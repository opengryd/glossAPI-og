# MinerU (magic-pdf) environment
#
# Copy this file to .env_mineru and adjust the paths for your machine:
#   cp dependency_setup/.env_mineru.example dependency_setup/.env_mineru
# Then source it before running the pipeline:
#   source dependency_setup/.env_mineru

# ---------------------------------------------------------------------------
# Shared weights root (all backends look under subdirectories here)
# ---------------------------------------------------------------------------
export GLOSSAPI_WEIGHTS_ROOT=/path/to/glossAPI/model_weights

# ---------------------------------------------------------------------------
# OCR control — set ENABLE_OCR=1 to run real magic-pdf; ENABLE_STUB controls
# fallback to stub when the CLI fails or is unavailable.
# ---------------------------------------------------------------------------
export GLOSSAPI_MINERU_ENABLE_OCR=1
export GLOSSAPI_MINERU_ENABLE_STUB=0

# ---------------------------------------------------------------------------
# magic-pdf binary location
# Auto-detected via PATH if not set; set explicitly when using a venv.
# ---------------------------------------------------------------------------
export GLOSSAPI_MINERU_COMMAND=/path/to/glossAPI/dependency_setup/.venvs/mineru-py312/bin/magic-pdf

# ---------------------------------------------------------------------------
# Pipeline execution mode: auto | fast | accurate
# ---------------------------------------------------------------------------
export GLOSSAPI_MINERU_MODE=auto

# ---------------------------------------------------------------------------
# Backend engine override: pipeline | hybrid-auto-engine | auto (default)
# auto resolves to hybrid-auto-engine on MPS/CUDA machines and pipeline on CPU.
# ---------------------------------------------------------------------------
# export GLOSSAPI_MINERU_BACKEND=auto

# ---------------------------------------------------------------------------
# Device mode: mps | cuda | cpu  (auto-detected from torch if not set)
# ---------------------------------------------------------------------------
# export GLOSSAPI_MINERU_DEVICE_MODE=mps

# ---------------------------------------------------------------------------
# MinerU tools config JSON.
# Auto-resolved from GLOSSAPI_WEIGHTS_ROOT/mineru/magic-pdf.json if not set.
# Explicit override:
# ---------------------------------------------------------------------------
# export MINERU_TOOLS_CONFIG_JSON=/path/to/glossAPI/model_weights/mineru/magic-pdf.json

# ---------------------------------------------------------------------------
# Page batch size for MinerU inference.
# MinerU processes the PDF in chunks of this many pages, running the full
# model stack (Layout, MFD, MFR, OCR) per chunk before moving to the next.
# Smaller values reduce the number of formula crops in a single MFR pass,
# which limits per-pass state accumulation at the cost of extra warm-up
# invocations for Layout and MFD.
# ---------------------------------------------------------------------------
# export MINERU_MIN_BATCH_INFERENCE_SIZE=50

# ---------------------------------------------------------------------------
# Model-level batch sizes (injected into the resolved magic-pdf.json).
# These directly control how many crops/items are fed to each model per GPU
# batch.  Smaller values reduce peak unified-memory pressure on Apple Silicon,
# preventing throughput collapse mid-stage (e.g. MFR: 25 it/s → <3 it/s).
#
# MFR (formula recognition) — most impactful; autoregressive seq2seq model.
#   MinerU default: ~64.  Recommended on MPS: 8–16 (lower = smaller GC stalls).
# export GLOSSAPI_MINERU_MFR_BATCH_SIZE=16
#
# OCR-rec (text crop decoder) — moderate impact.
#   MinerU default: ~6.  Explicitly pinning avoids version-to-version drift.
# export GLOSSAPI_MINERU_OCR_REC_BATCH_SIZE=6
#
# Layout detection — one-shot CNN, less memory-sensitive.
#   Leave unset to use MinerU's default.
# export GLOSSAPI_MINERU_LAYOUT_BATCH_SIZE=
#
# Set any value to 0 to opt out and revert to MinerU's own default.
# ---------------------------------------------------------------------------

# ---------------------------------------------------------------------------
# MPS allocator watermarks (Apple Silicon only).
# Default (0.0): disables PyTorch's synchronous budget GC entirely.
# PyTorch then relies on macOS system pressure events, which are asynchronous
# and don't stall the GPU during MFR autoregressive decoding.
# Set to "off" to skip injection and revert to PyTorch's own default (1.7).
# Set to a float > 0 (e.g. 1.0) to use ratio-based GC instead.
# ---------------------------------------------------------------------------
# export GLOSSAPI_MINERU_MPS_HIGH_WATERMARK_RATIO=0.0

# ---------------------------------------------------------------------------
# Skip Docling bootstrap at import time (not needed for MinerU-only runs).
# ---------------------------------------------------------------------------
export GLOSSAPI_SKIP_DOCLING_BOOT=1
